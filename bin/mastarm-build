#!/usr/bin/env node

var errorify = require('errorify')
var fs = require('fs')
var watchify = require('watchify')

var auto = require('../lib/auto')()
var build = require('../lib/build')

var pipeline = build({
  config: auto.config,
  debug: auto.argv.debug,
  entry: auto.entry,
  env: auto.env,
  outfile: auto.outfile
})

if (auto.argv.watch) {
  pipeline.plugin(watchify, { poll: true })
  pipeline.plugin(errorify)
}

pipeline.on('update', bundle)
bundle()

function bundle () {
  pipeline
    .bundle()
    .pipe(fs.createWriteStream(auto.outfile))
}
