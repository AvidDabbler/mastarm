#!/usr/bin/env node

const errorify = require('errorify')
const fs = require('fs')
const watchify = require('watchify')

const auto = require('../lib/auto')()
const build = require('../lib/build')

auto.files.map(run)

function run ([entry, outfile]) {
  const pipeline = build({
    config: auto.config,
    debug: auto.argv.debug,
    entry,
    env: auto.env,
    outfile
  })

  if (auto.argv.watch) {
    pipeline.plugin(watchify, { poll: true })
    pipeline.plugin(errorify)
    pipeline.on('update', bundle)
  }

  function bundle () {
    pipeline
      .bundle()
      .pipe(fs.createWriteStream(outfile))
  }

  bundle()
}
