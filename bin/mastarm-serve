#!/usr/bin/env node

var budo = require('budo')
var httpProxy = require('http-proxy')
var loadConfig = require('../lib/load-config')
var argv = require('minimist')(process.argv.slice(2))
var transform = require('../lib/transform')

var config = loadConfig(process.cwd(), argv.config)

var middleware = []
if (argv.proxy) {
  var url = config.settings.api || '/api'
  var proxy = httpProxy.createProxyServer({target: argv.proxy})
  middleware.push(function (req, res, next) {
    if (req.url.indexOf(url) === 0) {
      req.url = req.url.slice(url.length)
      proxy.web(req, res)
    } else {
      next()
    }
  })
}

budo.cli([argv._[0] + ':assets/index.js'], {
  browserify: {debug: true, transform: transform(config)},
  cors: true,
  middleware: middleware
})
